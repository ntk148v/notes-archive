<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/notes/styles.34c1555eaf028a1bf318.css" id="gatsby-global-css">.tippy-box[data-animation=shift-away][data-state=hidden]{opacity:0}.tippy-box[data-animation=shift-away][data-state=hidden][data-placement^=top]{transform:translateY(10px)}.tippy-box[data-animation=shift-away][data-state=hidden][data-placement^=bottom]{transform:translateY(-10px)}.tippy-box[data-animation=shift-away][data-state=hidden][data-placement^=left]{transform:translateX(10px)}.tippy-box[data-animation=shift-away][data-state=hidden][data-placement^=right]{transform:translateX(-10px)}</style><meta name="generator" content="Gatsby 3.2.0"/><link as="script" rel="preload" href="/notes/webpack-runtime-6ab9c6bdeef07b34c110.js"/><link as="script" rel="preload" href="/notes/framework-544fcf5a97337ccb1485.js"/><link as="script" rel="preload" href="/notes/app-180b2c4c68d8cb58bd57.js"/><link as="script" rel="preload" href="/notes/component---node-modules-gatsby-theme-andy-src-templates-note-js-f60ab987f54412c8d336.js"/><link as="fetch" rel="preload" href="/notes/page-data/prometheus-service-discovery/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/notes/page-data/app-data.json" crossorigin="anonymous"/></head><body><script>(function() { try {
  var mode = localStorage.getItem('theme-ui-color-mode');
  if (!mode) return
  document.body.classList.add('theme-ui-' + mode);
} catch (e) {} })();</script><div id="___gatsby"><style data-emotion-css="n0ecfm">body{color:var(--theme-ui-colors-text,#333);background-color:var(--theme-ui-colors-background,#fff);}</style><style data-emotion-css="1fthmpb">*{box-sizing:border-box;}body{margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",sans-serif;line-height:1.5;font-weight:400;}</style><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><style data-emotion-css="bya3fr">.css-bya3fr{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;height:100vh;min-height:100vh;}</style><style data-emotion-css="1ehwac2">.css-1ehwac2{box-sizing:border-box;margin:0;min-width:0;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;height:100vh;min-height:100vh;}</style><div class="css-1ehwac2"><header><style data-emotion-css="b38cxh">.css-b38cxh{border-bottom:1px solid;border-color:var(--theme-ui-colors-gray,#dadada);}</style><style data-emotion-css="bjpuxf">.css-bjpuxf{box-sizing:border-box;margin:0;min-width:0;padding-top:8px;padding-bottom:8px;padding-left:16px;padding-right:16px;border-bottom:1px solid;border-color:var(--theme-ui-colors-gray,#dadada);}</style><div class="css-bjpuxf"><style data-emotion-css="12j45zb">.css-12j45zb{font-weight:700;color:var(--theme-ui-colors-text,#333);-webkit-text-decoration:none;text-decoration:none;}</style><a class="css-12j45zb" href="/notes/">@kiennt&#x27;s notes</a></div></header><style data-emotion-css="lxqeq9">.css-lxqeq9{-webkit-flex:1;-ms-flex:1;flex:1;-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;overflow-y:hidden;}@media screen and (min-width:768px){.css-lxqeq9{overflow-x:auto;}}</style><style data-emotion-css="1xopae2">.css-1xopae2{box-sizing:border-box;margin:0;min-width:0;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex:1;-ms-flex:1;flex:1;-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;overflow-y:hidden;}@media screen and (min-width:768px){.css-1xopae2{overflow-x:auto;}}</style><div class="css-1xopae2"><style data-emotion-css="9ms8w3">.css-9ms8w3{min-width:unset;-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;-webkit-transition-duration:100px;transition-duration:100px;width:100%;}@media screen and (min-width:640px){.css-9ms8w3{width:100%;}}@media screen and (min-width:768px){.css-9ms8w3{-webkit-transition:width;transition:width;width:1152px;}}</style><style data-emotion-css="1806l1h">.css-1806l1h{box-sizing:border-box;margin:0;min-width:0;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;min-width:unset;-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;-webkit-transition-duration:100px;transition-duration:100px;width:100%;}@media screen and (min-width:640px){.css-1806l1h{width:100%;}}@media screen and (min-width:768px){.css-1806l1h{-webkit-transition:width;transition:width;width:1152px;}}</style><div class="note-columns-container css-1806l1h"><style data-emotion-css="q7ai65">.css-q7ai65{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;overflow-y:auto;max-width:100%;width:100%;left:0;right:-585px;}@media screen and (min-width:640px){.css-q7ai65{max-width:100%;width:100%;}}@media screen and (min-width:768px){.css-q7ai65{position:-webkit-sticky;position:sticky;max-width:100vw;width:576px;}}</style><style data-emotion-css="108dckd">.css-108dckd{box-sizing:border-box;margin:0;min-width:0;padding-left:16px;padding-right:16px;background-color:var(--theme-ui-colors-background,#fff);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;overflow-y:auto;max-width:100%;width:100%;left:0;right:-585px;}@media screen and (min-width:640px){.css-108dckd{max-width:100%;width:100%;}}@media screen and (min-width:768px){.css-108dckd{position:-webkit-sticky;position:sticky;max-width:100vw;width:576px;}}</style><div class="note-container css-108dckd"><style data-emotion-css="qkbcne">.css-qkbcne{display:none;-webkit-transition:opacity;transition:opacity;-webkit-transition-duration:100px;transition-duration:100px;opacity:0;}@media screen and (min-width:640px){.css-qkbcne{display:none;}}@media screen and (min-width:768px){.css-qkbcne{display:block;}}</style><style data-emotion-css="1d4xrqf">.css-1d4xrqf{box-sizing:border-box;margin:0;min-width:0;display:none;-webkit-transition:opacity;transition:opacity;-webkit-transition-duration:100px;transition-duration:100px;opacity:0;}@media screen and (min-width:640px){.css-1d4xrqf{display:none;}}@media screen and (min-width:768px){.css-1d4xrqf{display:block;}}</style><div class="css-1d4xrqf"><style data-emotion-css="1557ki8">.css-1557ki8{position:absolute;z-index:10;-webkit-transform:rotate(90deg);-ms-transform:rotate(90deg);transform:rotate(90deg);-webkit-transform-origin:left;-ms-transform-origin:left;transform-origin:left;}</style><style data-emotion-css="1vxydnz">.css-1vxydnz{box-sizing:border-box;margin:0;min-width:0;padding-bottom:8px;position:absolute;z-index:10;-webkit-transform:rotate(90deg);-ms-transform:rotate(90deg);transform:rotate(90deg);-webkit-transform-origin:left;-ms-transform-origin:left;transform-origin:left;}</style><div class="css-1vxydnz"><style data-emotion-css="y5zp6v">.css-y5zp6v{font-weight:700;-webkit-text-decoration:none;text-decoration:none;color:var(--theme-ui-colors-text,#333);}</style><a class="css-y5zp6v" href="/notes/prometheus-service-discovery/prometheus-service-discovery">prometheus-service-discovery</a></div></div><style data-emotion-css="1jnayfl">.css-1jnayfl{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;min-height:100%;-webkit-transition:opacity;transition:opacity;-webkit-transition-duration:100px;transition-duration:100px;opacity:1;}</style><style data-emotion-css="1xvlbb1">.css-1xvlbb1{box-sizing:border-box;margin:0;min-width:0;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;min-height:100%;-webkit-transition:opacity;transition:opacity;-webkit-transition-duration:100px;transition-duration:100px;opacity:1;}</style><div class="css-1xvlbb1"><style data-emotion-css="1rr4qq7">.css-1rr4qq7{-webkit-flex:1;-ms-flex:1;flex:1;}</style><div class="css-1rr4qq7"><style data-emotion-css="1ebprri">.css-1ebprri{margin-top:16px;margin-bottom:16px;}</style><style data-emotion-css="xz3bt">.css-xz3bt{color:#333;font-family:inherit;line-height:1.125;font-weight:700;font-size:32px;margin-top:16px;margin-bottom:16px;}</style><h1 class="css-xz3bt">prometheus-service-discovery</h1><style data-emotion-css="1ccy11i">.css-1ccy11i{color:#333;font-family:inherit;line-height:1.125;font-weight:700;font-size:32px;color:#333;font-family:inherit;line-height:1.125;font-weight:700;font-size:32px;}</style><h1 class="css-1ccy11i">Prometheus Service Discovery</h1><blockquote class="css-0"><style data-emotion-css="19iowwu">.css-19iowwu{color:#333;color:#333;}</style><p class="css-19iowwu"><strong class="css-0">NOTE</strong>: It&#x27;s a raw version, will re-work it soon :clown_face:</p></blockquote><p class="css-19iowwu">Service discovery (SD) enables you to provide that information to Prometheus from whichever database you store it in. Prometheus supports many common sources of service information, such as Consul, Amazon&#x27;s EC2 and Kubernetes out of the box. If your particular source isn&#x27;t already supported, you can use the file-based service discovery mechanism to hook it in. This could be by having your configuration management system, such as Ansible or Chef, write the list of machines and services they know about in the right format, or a script running regularly to pull it from whatever data source you use.</p><p class="css-19iowwu">[TOC]</p><style data-emotion-css="cq6ij1">.css-cq6ij1{color:#333;font-family:inherit;line-height:1.125;font-weight:700;font-size:24px;color:#333;font-family:inherit;line-height:1.125;font-weight:700;font-size:24px;}</style><h2 class="css-cq6ij1">Service Discovery Mechanisms</h2><p class="css-19iowwu">Service discovery isn&#x27;t just about you providing a list of machines to Prometheus, or monitoring. It is a more general concern that you will see across your systems; applications need to find their dependencies to talk to, and hardware technicians need to know which machines are safe to turn off and repair.</p><p class="css-19iowwu">A good service discovery mechanism will provide you with <em class="css-0">metadata</em>. Metadata is what you will convert into target labels, and generally the more metadata you have, the better.</p><style data-emotion-css="jgtg8i">.css-jgtg8i{color:#333;font-family:inherit;line-height:1.125;font-weight:700;font-size:20px;color:#333;font-family:inherit;line-height:1.125;font-weight:700;font-size:20px;}</style><h3 class="css-jgtg8i">Static</h3><ul class="css-0"><li class="css-0">Static configuration where targets are provided directly in the prometheus.yml.</li><li class="css-0">Combining with a configuration management tool such as Ansible, you could have its templating system write out a list of all the machines it knows about to have their Node exporters scraped.</li></ul><style data-emotion-css="mwhsaa">.css-mwhsaa{font-family:Menlo,monospace;overflow-x:auto;font-family:Menlo,monospace;overflow-x:auto;}.css-mwhsaa code{color:inherit;}.css-mwhsaa code{color:inherit;}</style><pre class="css-mwhsaa"><style data-emotion-css="tej46y">.css-tej46y{font-family:Menlo,monospace;font-size:inherit;font-family:Menlo,monospace;font-size:inherit;}</style><code class="language-yaml css-tej46y">scape_configs:
  - job_name: node
    static_configs:
      - targets:
{% for host ini groups[&quot;all&quot;] %}
        - {{ host }}:9100
{% endfor %}
</code></pre><h3 class="css-jgtg8i">File</h3><ul class="css-0"><li class="css-0">File SD</li><li class="css-0">It reads monitoring targets from files you provide on the local filesystem.</li><li class="css-0">JSON or YAML formats.</li></ul><pre class="css-mwhsaa"><code class="language-json css-tej46y">[
    {
        &quot;targets&quot;: [&quot;host1:9100&quot;, &quot;host2:9100&quot;],
        &quot;labels&quot;: {
            &quot;team&quot;: &quot;infra&quot;,
            &quot;job&quot;: &quot;node&quot;
        }
    },
    {
        &quot;targets&quot;: [&quot;host1:9090&quot;],
        &quot;labels&quot;: {
            &quot;team&quot;: &quot;monitoring&quot;,
            &quot;job&quot;: &quot;prometheus&quot;
        }
    }
]
</code></pre><ul class="css-0"><li class="css-0">Issue with JSON format is that the last item in a list or hash cannot have a trailing comma --&gt; using JSON library to generate JSON files rather than trying to do it by hand.</li></ul><pre class="css-mwhsaa"><code class="language-yaml css-tej46y">scrape_configs:
  - job_name: file
    file_sd_configs:
      - files:
          - &#x27;*.json&#x27;
</code></pre><ul class="css-0"><li class="css-0">Providing the targets with a file means it could come from templating in a configuration management system, a daemon that writes it out regularly, or even from a web service via a cronjob using wget.</li><li class="css-0">Changes are picked up automatically using inotify.</li></ul><h3 class="css-jgtg8i">Consul</h3><ul class="css-0"><li class="css-0">Consul service discovery is a service discovery mechanism that uses the network.</li><li class="css-0">Consul has an agent that runs on each of your machines, and these gossip amongst themselves. Applications talk only to the local agent on a machine.</li></ul><p class="css-19iowwu"><style data-emotion-css="1k89gbo">.css-1k89gbo{max-width:100%;max-width:100%;}</style><img src="https://www.consul.io/assets/images/consul-arch-420ce04a.png" alt="Image result for consul architecture" class="css-1k89gbo"/></p><ul class="css-0"><li class="css-0">Sample config:</li></ul><pre class="css-mwhsaa"><code class="language-yaml css-tej46y">scrape_configs:
  - job_name: consul
    consul_sd_configs:
      - server: &#x27;localhost:8500&#x27;
</code></pre><h2 class="css-cq6ij1">Relabelling</h2><ul class="css-0"><li class="css-0">Tell Prometheus how to map from metadata to targets using <em class="css-0">relabelling</em>.</li><li class="css-0">Check <style data-emotion-css="18ci6ln">.css-18ci6ln{color:#3182ce;-webkit-text-decoration:none;text-decoration:none;}.css-18ci6ln:hover{-webkit-text-decoration:underline;text-decoration:underline;}</style><style data-emotion-css="embvvb">.css-embvvb{color:#3182ce;padding-left:2px;padding-right:2px;margin-left:-2px;margin-right:-2px;border-radius:4px;color:#3182ce;-webkit-text-decoration:none;text-decoration:none;}.css-embvvb:hover{background-color:#fafafc;}.css-embvvb:focus{background-color:#fafafc;}.css-embvvb:hover{-webkit-text-decoration:underline;text-decoration:underline;}</style><a class="css-embvvb" href="/notes/prometheus-service-discovery/labels.md">prometheus labels note.</a></li></ul><h2 class="css-cq6ij1">Choosing what to scrape</h2><ul class="css-0"><li class="css-0">Which targets you actually want to scrape.</li><li class="css-0"><em class="css-0">relabel action</em> + <em class="css-0">regex</em>.</li><li class="css-0">Using a keep relabel action to only monitor targets with a team=&quot;infra&quot; label.</li></ul><pre class="css-mwhsaa"><code class="language-yaml css-tej46y">scrape_configs:
  - job_name: file
    file_sd_configs:
      - files:
         - &#x27;*.json&#x27;
    relabel_configs:
      - source_labels: [team]
        regex: infra
        action: keep
</code></pre><ul class="css-0"><li class="css-0">Two relabel actions requiring contradictory values for the team label.</li></ul><pre class="css-mwhsaa"><code class="language-yaml css-tej46y">scrape_configs:
  - job_name: file
    file_sd_configs:
      - files:
          - &#x27;*.json&#x27;
    relabel_configs:
      - source_labels: [team]
        regex: infra
        action: keep
      - source_labels: [team]
        regex: monitoring
        action: keep
</code></pre><ul class="css-0"><li class="css-0">Using | to allow one label value or another.</li></ul><pre class="css-mwhsaa"><code class="language-yaml css-tej46y">scrape_configs:
  - job_name: file
    file_sd_configs:
      - files:
          - &#x27;*.json&#x27;
    relabel_configs:
      - source_labels: [team]
        regex: infra|monitoring
        action: keep
</code></pre><ul class="css-0"><li class="css-0">Using multiple source labels.</li></ul><pre class="css-mwhsaa"><code class="language-yaml css-tej46y">scrape_configs:
  - job_name: file
    file_sd_configs:
      - files:
          - &#x27;*.json&#x27;
    relabel_configs:
      - source_labels: [job, team]
        regex: prometheus;monitoring
        action: drop
</code></pre><h3 class="css-jgtg8i">Regular expressions</h3><ul class="css-0"><li class="css-0"><a class="css-18ci6ln" href="https://github.com/google/re2/wiki/Syntax">RE2</a> engine for regular expressions that comes with Go.</li></ul><h2 class="css-cq6ij1">Target labels</h2><ul class="css-0"><li class="css-0">Target labels are labels that are added to the labels of every time series returned from a scrape. They are <strong class="css-0">the identity of your targets</strong>, and accordingly they should not generally vary over time as might be the case with version numbers or machine owners.</li><li class="css-0">It is common to add target labels for the broader scope of the application, such as whether it is in development or production, their region, datacenter, and which team manages them.</li><li class="css-0">Target labels ultimately allow you to select, group, and aggregate targets in PromQL.</li><li class="css-0">Cost: Every addtional label is one more you need to keep in mind for every single PromQL expression you write.</li><li class="css-0">As a rule of thumb your target labels should be a hierarchy, with each one adding additional distinctiveness</li></ul><h3 class="css-jgtg8i">Replace - How to aggregate monitoring data according to the environment?</h3><ul class="css-0"><li class="css-0">Using relabelling to specify your target labels: <em class="css-0">replace action</em> - allows you to copy labels around, while also applying regular expressions.</li><li class="css-0">Using a replace relabel action to replace team=&quot;monitoring&quot; with team=&quot;monitor&quot;</li></ul><pre class="css-mwhsaa"><code class="language-yaml css-tej46y">scrape_configs:
  - job_name: file
    file_sd_configs:
      - files:
          - &#x27;*.json&#x27;
     relabel_configs:
       - source_labels: [team]
         regex: monitoring
         replacement: monitor
         target_label: team
         action: replace

</code></pre><ul class="css-0"><li class="css-0">Using a replace relabel action to remove a trailing from the team label.</li></ul><pre class="css-mwhsaa"><code class="language-yaml css-tej46y">scrape_configs:
  - job_name: file
    file_sd_configs:
      - files:
          - &#x27;*.json&#x27;
    relabel_configs:
      - source_labels: [team]
        regex: &#x27;(.*)ing&#x27;
        replacement: &#x27;${1}&#x27;
        target_label: team
        action: replace
</code></pre><ul class="css-0"><li class="css-0">Using a replace relabel action remove the team label</li></ul><pre class="css-mwhsaa"><code class="language-yaml css-tej46y">scrape_configs:
 - job_name: file
   file_sd_configs:
    - files:
      - &#x27;*.json&#x27;
   relabel_configs:
    - source_labels: []
      regex: &#x27;(.*)&#x27;
      replacement: &#x27;${1}&#x27;
      target_label: team
      action: replace
</code></pre><ul class="css-0"><li class="css-0">Using the defaults to remove the team label succinctly</li></ul><pre class="css-mwhsaa"><code class="language-yaml css-tej46y">scrape_configs:
 - job_name: file
   file_sd_configs:
    - files:
       - &#x27;*.json&#x27;
   relabel_configs:
    - source_labels: []
      target_label: team
</code></pre><ul class="css-0"><li class="css-0">Using the IP from Consul with port 9100 for the Node exporter</li></ul><pre class="css-mwhsaa"><code class="language-yaml css-tej46y">scrape_configs:
 - job_name: node
   consul_sd_configs:
    - server: &#x27;localhost:8500&#x27;
   relabel_configs:
    - source_labels: [__meta_consul_address]
      regex: &#x27;(.*)&#x27;
      replacement: &#x27;${1}:9100&#x27;
      target_label: __address__
</code></pre><ul class="css-0"><li class="css-0"><strong class="css-0">Tip</strong>: If relabelling produces 2 identical targets from one of your scrape  configs, they will be deduplicated automatically.</li></ul><h3 class="css-jgtg8i">job, instance and <!-- -->_<!-- -->_<!-- -->address<!-- -->_<!-- -->_</h3><ul class="css-0"><li class="css-0">If target has no <code class="css-0">instance</code> label, it is defaulted to the value of the <code class="css-0">__address__</code> label.</li><li class="css-0"><code class="css-0">instance</code> along with <code class="css-0">job</code> are two labels targets will always have, <code class="css-0">job</code> being defaulted from the <code class="css-0">job_name</code> configuration option.</li><li class="css-0">The<code class="css-0">__address__</code> is the host and port Prometheus will connect to when scraping.</li><li class="css-0"><strong class="css-0">Tip</strong>: Prometheus will perform DNS resolution on the <code class="css-0">__address__</code> --&gt; provide host:port rather than ip:port</li></ul><h3 class="css-jgtg8i">Labelmap</h3><ul class="css-0"><li class="css-0"><p class="css-19iowwu">The <code class="css-0">labelmap</code> action is different from the <code class="css-0">drop</code>, <code class="css-0">keep</code> and <code class="css-0">replace</code> actions you have already seen in that it applies to label names rather label values.</p></li><li class="css-0"><p class="css-19iowwu">Use the EC2 service tag as the job label, with all tags prefixed with monitor<!-- -->_<!-- -->as additional target labels.</p></li></ul><pre class="css-mwhsaa"><code class="language-yaml css-tej46y">scrape_configs:
  - job_name: ec2
    ec2_sd_configs:
      - region: &lt;region&gt;
        access_key: &lt;access key&gt;
        secret_key: &lt;secret key&gt;
    relabel_configs:
      - source_labels: [__meta_ec2_tag_service]
        target_label: job
      - regex: __meta_ec2_public_tag_monitor_(.*)
        replacement: &#x27;${1}&#x27;
        action: labelmap
</code></pre><h3 class="css-jgtg8i">Lists</h3><ul class="css-0"><li class="css-0">Some service discovery mechanisms just have a list of tags. --&gt; convert a list into key-value metadata. This is done by joining the items in the list with a comma and using the now-joined items as a label value. A comma is also put at the start and the end of the value, to make writing correct regular expressions easier.</li><li class="css-0">Keeping only Consul services with the prod tag</li></ul><pre class="css-mwhsaa"><code class="language-yaml css-tej46y">scrape_configs:
 - job_name: node
   consul_sd_configs:
    - server: &#x27;localhost:8500&#x27;
   relabel_configs:
    - source_labels: [__meta_consul_tag]
      regex:  &#x27;.*,prod,.*&#x27;
      action: keep
</code></pre><h2 class="css-cq6ij1">How to scrape</h2><h3 class="css-jgtg8i">Duplicate Jobs</h3><ul class="css-0"><li class="css-0"><code class="css-0">job_name</code> must be unique, as it is only a default, you are not prevented from having different scrape configs producing targets with the same job label.</li><li class="css-0">For example, if you had some jobs that required a different secretLabel clashes and honor_labels which were indicated by a Consul tag, you could segregate them using keep and drop actions, and then use a <code class="css-0">replace</code> to set the <code class="css-0">job</code> label</li></ul><pre class="css-mwhsaa"><code class="language-yaml css-tej46y">- job_name: my_job
   consul_sd_configs:
    - server: &#x27;localhost:8500&#x27;
   relabel
    - source_labels: [__meta_consul_tag]
      regex:  &#x27;.*,specialsecret,.*&#x27;
      action: drop
   basic_auth:
     username: brian
     password: normalSecret

 - job_name: my_job_special_secret
   consul_sd_configs:
    - server: &#x27;localhost:8500&#x27;
   relabel
    - source_labels: [__meta_consul_tag]
      regex:  &#x27;.*,specialsecret,.*&#x27;
      action: keep
    - replacement: my_job
      target_label: job
   basic_auth:
     username: brian
     password: specialSecret
</code></pre><h3 class="css-jgtg8i">metric<!-- -->_<!-- -->label<!-- -->_<!-- -->configs</h3><ul class="css-0"><li class="css-0">Check <a class="css-embvvb" href="/notes/prometheus-service-discovery/labels.md">labels</a></li><li class="css-0"><code class="css-0">labeldrop</code> and <code class="css-0">labelkeep</code>: relabel actions that are unlikely to be ever required for target relabelling, but that can come up in metric relabelling.</li><li class="css-0">Similar to <code class="css-0">labelmap</code>, they apply to label names rather than to label values. Instead of copying labels, <code class="css-0">labeldrop</code> and <code class="css-0">labelkeep</code> remove labels.</li><li class="css-0">Dropping all scraped labels that begin with node_</li></ul><pre class="css-mwhsaa"><code class="language-yaml css-tej46y">scrape_configs:
 - job_name: misbehaving
   static_configs:
    - targets:
       - localhost:1234
   metric_relabel_configs:
    - regex: &#x27;node_.*&#x27;
      action: labeldrop
</code></pre></div><style data-emotion-css="rl6otz">.css-rl6otz{border-radius:8px;}</style><style data-emotion-css="19qk7ja">.css-19qk7ja{box-sizing:border-box;margin:0;min-width:0;padding:16px;margin-bottom:8px;background-color:#fafafc;color:#718096;border-radius:8px;}</style><div class="css-19qk7ja"><style data-emotion-css="rp57em">.css-rp57em{box-sizing:border-box;margin:0;min-width:0;font-family:inherit;font-weight:700;line-height:1.125;color:#718096;}</style><h4 class="css-rp57em">Referred in</h4><style data-emotion-css="19idom">.css-19idom{margin-bottom:8px;}</style><div class="css-19idom"><style data-emotion-css="ovwx2x">.css-ovwx2x{-webkit-text-decoration:none;text-decoration:none;color:#718096;}.css-ovwx2x:hover{color:#333;}</style><a class="css-ovwx2x" href="/notes/about"><style data-emotion-css="1jpm9pd">.css-1jpm9pd{padding-top:8px;padding-bottom:8px;}</style><div class="css-1jpm9pd"><style data-emotion-css="18iut6x">.css-18iut6x{font-size:16px;margin:0;color:#718096;}</style><style data-emotion-css="ouorfz">.css-ouorfz{color:#333;font-size:16px;margin:0;color:#718096;}</style><p class="css-ouorfz">About these notes</p><style data-emotion-css="uvfa58">.css-uvfa58{font-size:14px;margin:0;color:#718096;}</style><style data-emotion-css="1hddlwb">.css-1hddlwb{color:#333;font-size:14px;margin:0;color:#718096;}</style><p class="css-1hddlwb">Hi, I&#x27;m  Kien Nguyen-Tuan  ðŸ‘‹. prometheus-promql-gotchas prometheus-prometheus-promql-join prometheus-prometheus-labels-relabel prometheusâ€¦</p></div></a></div><style data-emotion-css="4erca1">.css-4erca1{margin-left:auto;margin-right:auto;width:64px;}</style><hr class="css-4erca1"/><style data-emotion-css="1cev0y9">.css-1cev0y9{margin:0;font-size:14px;}</style><p class="css-1cev0y9">If you think this note resonated, be it positive or negative, please feel free to send me an<!-- --> <style data-emotion-css="15vz5gh">.css-15vz5gh{-webkit-text-decoration:underline;text-decoration:underline;color:#718096;}</style><style data-emotion-css="lnu7pe">.css-lnu7pe{color:#3182ce;-webkit-text-decoration:none;text-decoration:none;-webkit-text-decoration:underline;text-decoration:underline;color:#718096;}.css-lnu7pe:hover{-webkit-text-decoration:underline;text-decoration:underline;}</style><a href="mailto:kiennt2609@gmail.com" class="css-lnu7pe">email</a> <!-- -->and we can talk.</p></div></div></div></div></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/prometheus-service-discovery";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-534f3e0c52e5660f4540.js"],"app":["/app-180b2c4c68d8cb58bd57.js"],"component---node-modules-gatsby-theme-andy-src-templates-note-js":["/component---node-modules-gatsby-theme-andy-src-templates-note-js-f60ab987f54412c8d336.js"]};/*]]>*/</script><script src="/notes/polyfill-534f3e0c52e5660f4540.js" nomodule=""></script><script src="/notes/component---node-modules-gatsby-theme-andy-src-templates-note-js-f60ab987f54412c8d336.js" async=""></script><script src="/notes/app-180b2c4c68d8cb58bd57.js" async=""></script><script src="/notes/framework-544fcf5a97337ccb1485.js" async=""></script><script src="/notes/webpack-runtime-6ab9c6bdeef07b34c110.js" async=""></script></body></html>